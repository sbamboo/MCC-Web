<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MinecraftCustomClient - Website (ModView)</title>
        <link rel="stylesheet" href="./css/index.css">
        <link rel="stylesheet" href="./css/modview.css">
        <link rel="icon" type="image/png" href="./images/favicon_128.png">
        <!-- Include the JSZip library from CDN -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    </head>
    <noscript>
        <style type="text/css">
            #pagecontent {display:none;}
        </style>
        <div class="noscriptmsg">
            <p>You don't have javascript enabled, this website sadly relies on javascript to function.<br>
            Please turn on javascript or alternatively download modpacks and related assets from the github repository: <a href="https://github.com/sbamboo/MinecraftCustomClient">sbamboo/MinecraftCustomClient</a></p>
            <footer><p class="smal-text">Created by Simon Kalmi Claesson for personal use, any content on this website is owned by the author and is not permitted to be redistrubuted without crediting the original author, redistributing any assets/parts or the project as a whole as your own is not and never will be allowed.</p></footer>
        </div>
    </noscript>
    <body><div id="pagecontent">
        <header>
            <a class="title-link" href="./"><div class="title sideflex">
                <h1>MinecraftCustomClient</h1>
                <img src="./images/favicon2_128.png" alt="Logo">
            </div></a>
            <div class="hr"></div>
            <br>
        </header>
        <main>
            <div id="readme">
                <div id="modview-content"><h1 id="modview-content-replacable-loading">Loading...</h1></div>
                <script>

                    function generateRandomString(length) {
                        const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                        let result = '';
                        for (let i = 0; i < length; i++) {
                            const randomIndex = Math.floor(Math.random() * charset.length);
                            result += charset[randomIndex];
                        }
                        return result;
                    }

                    const modrinth_api_requestOptions = {
                        headers: {
                            'User-Agent': "minecraftcustomclient-website@".concat(generateRandomString(8))
                        }
                    };
                    console.log("Set modrinth-api-fetch user to: ".concat(modrinth_api_requestOptions.headers['User-Agent']));

                    seenFallbacks = Array();

                    // Fetch data from the specified URL
                    function fetchData(url) {
                        return fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error("Network response was not ok");
                                }
                                return response.json(); // Parse response as JSON
                            })
                            .catch(error => {
                                console.error("Error fetching data:", error);
                                throw error; // Rethrow the error to be caught by the caller
                            });
                    }
                
                    //apilink = `https://api.curse.tools/v1/cf/mods/${curseforgeProjId}`

                    // Modicon fallback
                    function modiconFallback(elem,type,id) {
                        amnt = seenFallbacks.filter(x => x === id).length;
                        if (type == "modrinth") {
                            if (id == null || id == undefined || id == "undefined" || id == "" || id == "null") {
                                elem.src = './images/modview/missing-mod-icon.png';
                            } else {
                                if (amnt < 5) {
                                    console.log(`Modrinth fetch for ${id} try ${amnt} allowed.`)
                                    seenFallbacks.push(id);
                                    fetch(`https://api.modrinth.com/v2/project/${id}`,modrinth_api_requestOptions)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(`HTTP error! status: ${response.status}`);
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        elem.src = data.icon_url;
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                    });
                                } else {
                                    //console.log(`Modrinth fetch for ${id} try ${amnt} fallback.`)
                                    elem.src = './images/modview/missing-mod-icon.png';
                                }
                            }
                        } else if (type == "curseforge") {
                            if (id == null || id == undefined || id == "undefined" || id == "" || id == "null") {
                                elem.src = './images/modview/missing-mod-icon.png';
                            } else {
                                if (!seenFallbacks.includes(id)) {
                                    console.log(`Curseforge fetch for ${id} try ${amnt} allowed.`)
                                    fetch(`https://api.curse.tools/v1/cf/mods/${id}`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(`HTTP error! status: ${response.status}`);
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        elem.src = data.data.logo.thumbnailUrl;
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                    });
                                } else {
                                    //console.log(`Curseforge fetch for ${id} try ${amnt} skipped.`)
                                }
                            }
                        } else {
                            elem.src = './images/modview/missing-mod-icon.png';
                        }
                            
                    }

                    // Get URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const modpack = urlParams.get('modpack');
                
                    // The URL you want to fetch data from
                    const url = "https://raw.githubusercontent.com/sbamboo/MinecraftCustomClient/main/v2/Repo/repo.json";
                
                    // Reference to the <p> element where you want to display the content
                    const contentElement = document.getElementById("modview-content");
                    const loadingText = document.getElementById("modview-content-replacable-loading");
                
                    // Call the fetchData function to initiate the fetch
                    fetchData(url)
                        .then(data => {
                            // Access the "flavors" array
                            const flavors = data.flavors;

                            // Find the modpack
                            const dataOfModpack = flavors.find(flavor => flavor.name === modpack);
                
                            // If the modpack is found get mods based on type
                            if (dataOfModpack.sourceType == "mlisting") {
                                fetch(dataOfModpack.source)
                                    .then(response => response.blob())
                                    .then(zipBlob => {
                                        // Load the ZIP file using JSZip
                                        return JSZip.loadAsync(zipBlob);
                                    })
                                    .then(zip => {
                                        // Check if the listing.json file exists in the ZIP archive
                                        if (zip.files['listing.json']) {
                                            // Read the content of the listing.json file
                                            return zip.files['listing.json'].async('text');
                                        } else {
                                            throw new Error('File not found in the zip archive');
                                        }
                                    })
                                    .then(content => {
                                        loadingText.style.display = "none";
                                        try {
                                            // If all succeeds, parse the JSON content
                                            const jsonData = JSON.parse(content);
                                            console.log(jsonData);
                                            // Append sourceLength
                                            repoDomain = new URL(url).hostname;
                                            contentElement.innerHTML += `
                                            <div class="modview-listing-info">
                                                <h2 class="modview-source-name">${jsonData.name}</h2>
                                                <div class="hsep"></div>
                                                <p class="modview-info modview-from-repo">Repo: <a class="modview-from-repo-link" href="${url}">${repoDomain}</a></p>
                                                <p class="modview-info modview-source-author">Author: ${dataOfModpack.author}</p>
                                                <p class="modview-info modview-source-mcver">Minecraft Version: ${jsonData.minecraftVer}</p>
                                                <p class="modview-info modview-source-modloader">Modloader: ${jsonData.modloader} ${jsonData.modloaderVer}</p>
                                                <p class="modview-info modview-source-format">Listing format: ${jsonData.format}</p>
                                                <div class="hsep"></div>
                                                <h3 class="modview-info modview-source-length">Showing ${jsonData.sourceLength} mods:</h3>
                                            </div>
                                            `;
                                            // Use the JSON data to get the mods
                                            jsonData.sources.forEach(mod => {
                                                // Display each mod, adjust as needed
                                                if (mod.type == "modrinth") {
                                                    hostname = new URL(mod.url).hostname;
                                                    icon = mod.url.split("/versions/")[0].concat("/icon.png");
                                                    modrinthid = mod.url.split("/versions/")[0].split("/").slice(-1)
                                                    modrinthModPage = "https://modrinth.com/mod/".concat(modrinthid)
                                                    contentElement.innerHTML += `
                                                    <div class="modview-mod modrinth-mod">
                                                        <img class="modview-icon modview-icon-size" src="${icon}" alt="Mod icon" onerror="modiconFallback(this,'modrinth','${modrinthid}');">
                                                        <div class="modview-section">
                                                            <p class="modview-filename">${mod.filename}</p>
                                                            <div class="modview-buttons">
                                                                <a class="modview-download modrinth-download" href="${mod.url}">
                                                                    <div class="modview-download-text">
                                                                        <img class="modview-download-text-icon" src="./images/modview/download.png" alt="Download icon">
                                                                        <p>Download via Modrinth</p>
                                                                    </div>
                                                                </a>
                                                                <a class="modview-download modrinth-site" href="${modrinthModPage}">
                                                                    <div class="modview-download-text">
                                                                        <img class="modview-download-text-icon" src="https://docs.modrinth.com/img/logo.svg" alt="Modrinth icon">
                                                                        <p>Modrinth Page</p>
                                                                    </div>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    `;
                                                } else if (mod.type == "curseforgeManifest") {
                                                    curseforgeProjId = mod.curseforgeProjId
                                                    if (curseforgeProjId == "") {
                                                        curseforgeProjId = null;
                                                    }
                                                    if (curseforgeProjId != null) {
                                                        fetch(`https://api.curse.tools/v1/cf/mods/${curseforgeProjId}`)
                                                            .then(response => {
                                                                if (!response.ok) {
                                                                    throw new Error(`HTTP error! status: ${response.status}`);
                                                                }
                                                                return response.json();
                                                            })
                                                            .then(data => {
                                                                contentElement.innerHTML += `
                                                                <div class="modview-mod curseforge-mod">
                                                                    <img class="modview-icon modview-icon-size" src="" alt="Mod icon" onerror="modiconFallback(this,'curseforge','${curseforgeProjId}');">
                                                                    <div class="modview-section">
                                                                        <p class="modview-filename">${mod.filename}</p>
                                                                        <div class="modview-buttons">
                                                                            <a class="modview-download curseforge-download" href="${mod.url}">
                                                                                <div class="modview-download-text">
                                                                                    <img class="modview-download-text-icon" src="./images/modview/download.png" alt="Download icon">
                                                                                    <p>Download via Curseforge</p>
                                                                                </div>
                                                                            </a>
                                                                            <a class="modview-download curseforge-site" href="${data.data.links.websiteUrl}"><div class="modview-download-text"><img class="modview-download-text-icon" src="./images/modview/curseforge.png" alt="Modrinth icon"><p>Curseforge Page</p></div></a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                `;
                                                            })
                                                            .catch(error => {
                                                                console.error('Error:', error);
                                                            });
                                                    } else {
                                                        contentElement.innerHTML += `
                                                        <div class="modview-mod curseforge-mod">
                                                            <img class="modview-icon modview-icon-size" src="" alt="Mod icon" onerror="modiconFallback(this,'curseforge','${curseforgeProjId}');">
                                                            <div class="modview-section">
                                                                <p class="modview-filename">${mod.filename}</p>
                                                                <div class="modview-buttons">
                                                                    <a class="modview-download curseforge-download" href="${mod.url}">
                                                                        <div class="modview-download-text">
                                                                            <img class="modview-download-text-icon" src="./images/modview/download.png" alt="Download icon">
                                                                            <p>Download via Curseforge</p>
                                                                        </div>
                                                                    </a>
                                                                    <a class="modview-download curseforge-search" href="https://www.curseforge.com/minecraft/search?page=1&pageSize=20&sortBy=relevancy&class=mc-mods&search=${mod.filename}"><div class="modview-download-text"><img class="modview-download-text-icon" src="./images/modview/curseforge.png" alt="Modrinth icon"><p>Search on Curseforge</p></div></a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        `;
                                                    }
                                                }
                                            });
                                        } catch (error) {
                                            throw new Error('Failed to parse listing.json: '.concat(error.message));
                                        }
                                    })
                                    .catch(error => {
                                        console.error(error.message);
                                        contentElement.textContent = "Error loading mods";
                                    });
                            // LEGACY
                            } else if (dataOfModpack.sourceType == "legacy") {
                                fetch(dataOfModpack.source.url)
                                    .then(response => response.blob())
                                    .then(zipBlob => {
                                        // Load the ZIP file using JSZip
                                        return JSZip.loadAsync(zipBlob);
                                    })
                                    .then(zip => {
                                        mods = Array();
                                        disabledMods = Array();
                                        zip.forEach((relativePath, file) => {
                                            if (relativePath.startsWith('mods')) {
                                                if (relativePath.endsWith('.jar')) {
                                                    mods.push(file);
                                                } else if (relativePath.endsWith('.dis')) {
                                                    disabledMods.push(file);
                                                }
                                            }
                                        });
                                        return Array(mods,disabledMods);
                                    })
                                    .then(modFiles => {
                                        loadingText.style.display = "none";
                                        console.log(modFiles);
                                        disabledModFiles = modFiles[1];
                                        modFiles = modFiles[0];
                                        try {
                                            // Append sourceLength
                                            repoDomain = new URL(url).hostname;
                                            contentElement.innerHTML += `
                                            <div class="modview-listing-info">
                                                <h2 class="modview-source-name">${dataOfModpack.name}</h2>
                                                <div class="hsep"></div>
                                                <p class="modview-info modview-from-repo">Repo: <a class="modview-from-repo-link" href="${url}">${repoDomain}</a></p>
                                                <p class="modview-info modview-source-author">Author: ${dataOfModpack.author}</p>
                                                <p class="modview-info modview-source-mcver">Minecraft Version: ${dataOfModpack.source.minecraftVer}</p>
                                                <p class="modview-info modview-source-modloader">Modloader: ${dataOfModpack.source.modLoader} ${dataOfModpack.source.modLoaderVer}</p>
                                                <p class="modview-info modview-source-format">Listing format: None, Legacy</p>
                                                <p class="modview-info modview-source-archtype">ArchiveType: ${dataOfModpack.source.archiveType}</p>
                                                <div class="hsep"></div>
                                                <h3 class="modview-info modview-source-length">Showing ${modFiles.length+disabledModFiles.length} mods:  (${disabledModFiles.length} disabled)</h3>
                                            </div>
                                            `;
                                            // Use the JSON data to get the mods
                                            modFiles.forEach(modFile => {
                                                // Display each mod, adjust as needed
                                                modFile.async("uint8array").then(function (uint8array) {
                                                    filename = modFile.name.split("/").slice(-1);
                                                    var blob = new Blob([uint8array], { type: "application/octet-stream" });
                                                    var blobUrl = URL.createObjectURL(blob);
                                                    contentElement.innerHTML += `
                                                    <div class="modview-mod legacy-mod">
                                                        <img class="modview-icon modview-icon-size" src="./images/modview/legacy.png" alt="Mod icon" onerror="modiconFallback(this,'legacy','');">
                                                        <div class="modview-section">
                                                            <p class="modview-filename">${filename}</p>
                                                            <div class="modview-buttons">
                                                                <a class="modview-download legacy-download blob-download" href="${blobUrl}" download="${filename}">
                                                                    <div class="modview-download-text">
                                                                        <img class="modview-download-text-icon" src="./images/modview/download.png" alt="Download icon">
                                                                        <p>Download from blob</p>
                                                                    </div>
                                                                </a>
                                                                <p class="modview-blob-warn">(OBS! <a href="./modview_issueswithblobs.html?redir-modpack=${modpack}">Issues with blobs</a>)</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    `;
                                                });
                                            });
                                            // Use the JSON data to get the mods
                                            disabledModFiles.forEach(modFile => {
                                                // Display each mod, adjust as needed
                                                modFile.async("uint8array").then(function (uint8array) {
                                                    console.log(modFile);
                                                    filename = modFile.name.split("/").slice(-1);
                                                    var blob = new Blob([uint8array], { type: "application/octet-stream" });
                                                    var blobUrl = URL.createObjectURL(blob);
                                                    contentElement.innerHTML += `
                                                    <div class="modview-mod legacy-mod disabled-mod">
                                                        <img class="modview-icon modview-icon-size" src="./images/modview/legacy.png" alt="Mod icon" onerror="modiconFallback(this,'legacy','');">
                                                        <div class="modview-section">
                                                            <p class="modview-filename">${filename} (Disabled)</p>
                                                            <div class="modview-buttons">
                                                                <a class="modview-download legacy-download blob-download" href="${blobUrl}" download="${filename}">
                                                                    <div class="modview-download-text">
                                                                        <img class="modview-download-text-icon" src="./images/modview/download.png" alt="Download icon">
                                                                        <p>Download from blob</p>
                                                                    </div>
                                                                </a>
                                                                <p class="modview-blob-warn">(OBS! <a href="./modview_issueswithblobs.html?redir-modpack=${modpack}">Issues with blobs</a>)</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    `;
                                                });
                                            });
                                        } catch (error) {
                                            throw new Error('Failed to parse listing.json: '.concat(error.message));
                                        }
                                    })
                                    .catch(error => {
                                        console.error(error.message);
                                        contentElement.textContent = "Error loading mods";
                                    });
                            }
                        })
                        .catch(error => {
                            contentElement.textContent = `Error fetching data: ${error.message}`;
                        });
                </script>
            </div>
            <a class="button big-size ui-btn btn-bellow-margin" href="./">Go back</a>
        </main>
        <footer>
            <p class="smal-text">Created by Simon Kalmi Claesson for personal use, any content on this website is owned by the author and is not permitted to be redistrubuted without crediting the original author, redistributing any assets/parts or the project as a whole as your own is not and never will be allowed.</p>
            <p class="smal-text" id="source-link-prefix">Website source: </p><a class="source-link" href="https://github.com/sbamboo/mcc-web">Github.com</a>
            <p class="smal-text" id="website-build-date">Website Build: 2023-11-21 (Failed check, might be incorrect)</p>
        </footer>
    </div></body>
    <script src="./js/get-lastmodify.js"></script>
</html>